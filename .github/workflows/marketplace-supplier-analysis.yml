name: Marketplace Supplier Analysis
run-name: Analyzing marketplace ${{ github.event.inputs.marketplace_url }} for supplier matching

on:
  workflow_dispatch:
    inputs:
      marketplace_url:
        description: 'Marketplace URL to analyze'
        required: true
        type: string
        default: 'https://www.extra.com'
      analysis_type:
        description: 'Type of analysis to perform'
        required: true
        type: choice
        options:
          - 'quick'
          - 'detailed'
          - 'batch'
        default: 'detailed'
      output_format:
        description: 'Output format'
        required: true
        type: choice
        options:
          - 'csv'
          - 'json'
          - 'both'
        default: 'both'
      max_suppliers:
        description: 'Maximum number of suppliers to return'
        required: false
        type: string
        default: '20'

jobs:
  analyze-marketplace:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 pandas openai selenium scrapy
          pip install python-dotenv
          
      - name: Set up environment variables
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "STORELEADS_API_KEY=${{ secrets.STORELEADS_API_KEY }}" >> .env
          
      - name: Setup analysis workspace
        run: |
          mkdir -p analysis_workspace
          # Copy the entire Suppliersourcing_for_marketplaces directory
          if [ -d "Obsidian Vault/Suppliersourcing_for_marketplaces" ]; then
            cp -r "Obsidian Vault/Suppliersourcing_for_marketplaces/"* analysis_workspace/
            echo "âœ… Copied existing analysis scripts and data"
          else
            echo "âŒ Suppliersourcing_for_marketplaces directory not found"
            exit 1
          fi
          
          # Copy enhanced analyzer script
          if [ -f "scripts/github_actions_enhanced_analyzer.py" ]; then
            cp scripts/github_actions_enhanced_analyzer.py analysis_workspace/
            chmod +x analysis_workspace/github_actions_enhanced_analyzer.py
            echo "âœ… Copied enhanced analyzer script"
          fi
          
          # Copy fallback analyzer script
          if [ -f "scripts/simple_marketplace_analyzer.py" ]; then
            cp scripts/simple_marketplace_analyzer.py analysis_workspace/
            chmod +x analysis_workspace/simple_marketplace_analyzer.py
            echo "âœ… Copied fallback analyzer script"
          fi
          
      - name: Verify data files
        run: |
          cd analysis_workspace
          echo "ðŸ“Š Checking data files..."
          
          # Check for CSV database
          if [ -f "Storeleads_shopify/all_japan_stores_unlimited.csv" ]; then
            echo "âœ… Found all_japan_stores_unlimited.csv"
            wc -l Storeleads_shopify/all_japan_stores_unlimited.csv
          else
            echo "âŒ all_japan_stores_unlimited.csv not found"
          fi
          
          # Check for marketplace list
          if [ -f "marketplacelist.txt" ]; then
            echo "âœ… Found marketplacelist.txt"
            wc -l marketplacelist.txt
          else
            echo "âš ï¸ marketplacelist.txt not found"
          fi
          
          # List available Python scripts
          echo "ðŸ Available Python scripts:"
          ls -la *.py | head -10
          
      - name: Create input file for analysis
        run: |
          cd analysis_workspace
          echo "${{ github.event.inputs.marketplace_url }}" > marketplace_input.txt
          echo "ðŸ“ Created marketplace_input.txt with URL: ${{ github.event.inputs.marketplace_url }}"
          
      - name: Run marketplace analysis
        run: |
          cd analysis_workspace
          
          echo "ðŸš€ Starting marketplace analysis..."
          echo "Analysis type: ${{ github.event.inputs.analysis_type }}"
          echo "Max suppliers: ${{ github.event.inputs.max_suppliers }}"
          
          # Check which scripts are available and run appropriate analysis
          if [ -f "enhanced_marketplace_analysis.py" ] && [ "${{ github.event.inputs.analysis_type }}" = "detailed" ]; then
            echo "ðŸš€ Running detailed analysis with enhanced_marketplace_analysis.py"
            python enhanced_marketplace_analysis.py
          elif [ -f "batch_marketplace_analysis.py" ] && [ "${{ github.event.inputs.analysis_type }}" = "batch" ]; then
            echo "ðŸš€ Running batch analysis with batch_marketplace_analysis.py"
            python batch_marketplace_analysis.py
          elif [ -f "simple_test_execution.py" ] && [ "${{ github.event.inputs.analysis_type }}" = "quick" ]; then
            echo "ðŸš€ Running quick analysis with simple_test_execution.py"
            python simple_test_execution.py
          else
            echo "ðŸš€ Running enhanced analysis with real database"
            python github_actions_enhanced_analyzer.py "${{ github.event.inputs.marketplace_url }}" "${{ github.event.inputs.max_suppliers }}"
          fi
          
          # Check if results were generated
          if [ -f matching_results_*.csv ]; then
            echo "âœ… Results generated successfully"
            ls -la matching_results_*.csv
          else
            echo "âš ï¸ No CSV results found, checking for other output files"
            ls -la *.csv *.json 2>/dev/null || echo "No output files found"
          fi
          
      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: marketplace-analysis-results
          path: analysis_workspace/matching_results_*.csv
          
      - name: Upload JSON results
        uses: actions/upload-artifact@v4
        with:
          name: marketplace-analysis-json
          path: analysis_workspace/matching_results_*.json
          
      - name: Generate summary report
        run: |
          cd analysis_workspace
          
          # Create a summary report
          echo "# Marketplace Analysis Report" > analysis_summary.md
          echo "" >> analysis_summary.md
          echo "**Analysis Date:** $(date)" >> analysis_summary.md
          echo "**Marketplace URL:** ${{ github.event.inputs.marketplace_url }}" >> analysis_summary.md
          echo "**Analysis Type:** ${{ github.event.inputs.analysis_type }}" >> analysis_summary.md
          echo "**Max Suppliers:** ${{ github.event.inputs.max_suppliers }}" >> analysis_summary.md
          echo "" >> analysis_summary.md
          
          # Count results
          result_count=$(ls matching_results_*.csv 2>/dev/null | wc -l)
          echo "**Number of CSV result files:** $result_count" >> analysis_summary.md
          
          json_count=$(ls matching_results_*.json 2>/dev/null | wc -l)
          echo "**Number of JSON result files:** $json_count" >> analysis_summary.md
          echo "" >> analysis_summary.md
          
          # List result files
          echo "## Generated Files" >> analysis_summary.md
          echo "### CSV Files" >> analysis_summary.md
          ls -la matching_results_*.csv >> analysis_summary.md 2>/dev/null || echo "No CSV files found"
          
          echo "### JSON Files" >> analysis_summary.md
          ls -la matching_results_*.json >> analysis_summary.md 2>/dev/null || echo "No JSON files found"
          
          # Show sample data if available
          if [ -f matching_results_*.csv ]; then
            echo "" >> analysis_summary.md
            echo "## Sample Results" >> analysis_summary.md
            echo "### First 5 lines of CSV:" >> analysis_summary.md
            echo '```' >> analysis_summary.md
            head -5 matching_results_*.csv >> analysis_summary.md 2>/dev/null || echo "Could not read CSV file"
            echo '```' >> analysis_summary.md
          fi
          
      - name: Upload summary report
        uses: actions/upload-artifact@v4
        with:
          name: analysis-summary
          path: analysis_workspace/analysis_summary.md
          
      - name: Comment on workflow run
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "## ðŸŽ¯ Marketplace Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Marketplace:** ${{ github.event.inputs.marketplace_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Analysis Type:** ${{ github.event.inputs.analysis_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Max Suppliers:** ${{ github.event.inputs.max_suppliers }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "Check the 'Artifacts' section below to download the analysis results." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Data Sources Used" >> $GITHUB_STEP_SUMMARY
          echo "- all_japan_stores_unlimited.csv (Japanese Shopify stores database)" >> $GITHUB_STEP_SUMMARY
          echo "- Enhanced marketplace analysis scripts" >> $GITHUB_STEP_SUMMARY
          echo "- StoreLeads API integration" >> $GITHUB_STEP_SUMMARY